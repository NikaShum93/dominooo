<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Falling Items — KGB</title>
<style>
  html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#fff}
  #game{position:relative;width:100%;height:100%;overflow:hidden;background:#111}
  .item{
    position:absolute; top:-120px; left:0;
    display:inline-flex; align-items:center; justify-content:center;
    min-width:100px; min-height:60px;
    cursor:pointer; user-select:none;
    transition:transform .2s;
  }
  .item .bg{
    position:absolute; inset:0;
    background:#1a1a1a;
    opacity:1;
    border:0 solid #fff;
    border-radius:10px;
    background-position:center; background-repeat:no-repeat; background-size:contain;
    z-index:0;
  }
  .item .content{
    position:relative; z-index:1;
    display:flex; align-items:center; justify-content:center;
    padding:18px 22px;
    max-width:300px; max-height:200px;
    text-align:center; line-height:1.15;
  }
  .item .content span{font-weight:800; white-space:nowrap;}
  .item .content img{max-width:160px; max-height:120px; object-fit:contain; pointer-events:none}
  /* фигуры */
  .shape-rect .bg{border-radius:10px}
  .shape-rounded .bg{border-radius:20px}
  .shape-circle .bg{border-radius:50%}
  .shape-diamond .bg{clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%)}
  .shape-star .bg{clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%)}
  /* эффекты */
  .fx-shadow .bg{box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .fx-glow .bg{box-shadow:0 0 18px var(--glow,#00f0ff)}
  .fx-3d .bg{box-shadow:7px 7px 20px rgba(0,0,0,.5), inset -5px -5px 12px rgba(255,255,255,.22)}
  .fx-border .bg{border-style:solid}
  /* HUD */
  #hud{position:absolute;top:10px;left:10px;z-index:10;font-family:Rubik, sans-serif;font-size:20px}
  #spark{position:absolute;pointer-events:none;z-index:999}
</style>
<link id="gf" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap">
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
<div id="game">
  <div id="hud">Очки: <span id="score">0</span></div>
  <canvas id="spark"></canvas>
</div>
<audio id="popSound" src="pop.mp3" preload="auto"></audio>
<script>
const url = new URLSearchParams(location.search);
const id = url.get('id');

let cfg=null, score=0, level=0, timer=null;
const game = document.getElementById('game');
const hudScore = document.getElementById('score');
const ctx = document.getElementById('spark').getContext('2d');
const popSound = document.getElementById('popSound');
let particles=[];

function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

// автофит текста
function autoFit(span, start, min){
  let fs=start; span.style.fontSize=fs+'px';
  const box=span.parentNode;
  const ok=()=>span.offsetWidth<=box.clientWidth-10 && span.offsetHeight<=box.clientHeight-10;
  if(ok()) return;
  while(fs>min){ fs--; span.style.fontSize=fs+'px'; if(ok()) break; }
}

// блёстки
function spawnSpark(x,y){
  for(let i=0;i<12;i++){
    particles.push({x,y,dx:(Math.random()-0.5)*6,dy:(Math.random()-0.5)*6,life:30});
  }
}
function drawSpark(){
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  particles.forEach(p=>{
    ctx.fillStyle='rgba(255,215,0,'+(p.life/30)+')';
    ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill();
    p.x+=p.dx; p.y+=p.dy; p.life--;
  });
  particles=particles.filter(p=>p.life>0);
  requestAnimationFrame(drawSpark);
}
function resizeSpark(){
  ctx.canvas.width=game.clientWidth; ctx.canvas.height=game.clientHeight;
}
window.addEventListener('resize',resizeSpark);resizeSpark();drawSpark();

// звук
function playPop(){ try{ popSound.currentTime=0; popSound.play(); }catch(e){} }

// создаём элемент
function spawnItem(text,isGood){
  const el=document.createElement('div');
  el.className='item shape-'+cfg.style.shape;
  if(cfg.style.shadow) el.classList.add('fx-shadow');
  if(cfg.style.fx3d) el.classList.add('fx-3d');
  if(cfg.style.glow){ el.classList.add('fx-glow'); el.style.setProperty('--glow', cfg.style.glowColor); }
  if(cfg.style.borderOn && cfg.style.borderWidth>0){
    el.classList.add('fx-border');
  }

  const bg=document.createElement('div'); bg.className='bg';
  bg.style.backgroundColor=cfg.style.bgColor;
  bg.style.opacity=cfg.style.opacity;
  if(cfg.style.bgImage){
    bg.style.backgroundImage=`url(${cfg.style.bgImage})`;
    bg.style.backgroundRepeat='no-repeat'; bg.style.backgroundSize='contain'; bg.style.backgroundPosition='center';
  }
  if(cfg.style.borderOn){
    bg.style.borderWidth=cfg.style.borderWidth+'px'; bg.style.borderColor=cfg.style.borderColor;
  }
  el.appendChild(bg);

  const content=document.createElement('div'); content.className='content';
  if(/^https?:\/\//i.test(text)){
    const img=document.createElement('img'); img.src=text; content.appendChild(img);
  } else if(cfg.language==='math' || text.startsWith('\\')){
    const span=document.createElement('span'); span.textContent=`\\(${text}\\)`; content.appendChild(span);
    setTimeout(()=>{ if(window.MathJax) MathJax.typesetPromise([content]); },50);
  } else {
    const span=document.createElement('span');
    span.textContent=text; span.style.color=cfg.textColor;
    span.style.fontFamily=cfg.font; span.style.fontSize=cfg.fontSize+'px';
    content.appendChild(span);
    autoFit(span,cfg.fontSize,12);
  }
  el.appendChild(content);

  el.style.left=Math.random()*(game.clientWidth-150)+'px';
  game.appendChild(el);

  let y=-100, alive=true;
  const speed=cfg.speed||5;
  function step(){
    if(!alive) return;
    y+=speed; el.style.top=y+'px';
    if(y>game.clientHeight+200){
      alive=false;
      if(isGood){ // штраф за пропуск
        score=Math.max(0,score-5); hudScore.textContent=score;
      }
      el.remove();
      return;
    }
    requestAnimationFrame(step);
  }
  step();

  el.addEventListener('click', e=>{
    alive=false; el.remove();
    if(isGood){
      score+=10; hudScore.textContent=score;
      spawnSpark(e.clientX,e.clientY); playPop();
    } else {
      score=Math.max(0,score-1); hudScore.textContent=score;
      bg.style.filter='brightness(2) saturate(1.6) hue-rotate(-30deg)';
      setTimeout(()=>bg.style.filter='none',200);
    }
  });
}

function startLevel(lv){
  score=0; hudScore.textContent=0;
  timer=setInterval(()=>{
    const arr=Math.random()<0.6?lv.correct:lv.wrong;
    if(!arr.length) return;
    const item=arr[Math.floor(Math.random()*arr.length)];
    spawnItem(item, lv.correct.includes(item));
  },1200);
  setTimeout(()=>{ clearInterval(timer); alert('Время вышло! Очки: '+score); }, lv.timer*1000);
}

// загрузка json
async function loadCfg(){
  const res=await fetch(`https://nikashum93.github.io/texts/data/${id}.json`);
  cfg=await res.json();
  applyGoogleFont(cfg.font);
  startLevel(cfg.levels[0]);
}
function applyGoogleFont(fontName){
  const gf=document.getElementById('gf');
  const family=fontName.replace(/ /g,'+');
  gf.href=`https://fonts.googleapis.com/css2?family=${family}:wght@400;700&display=swap`;
}
loadCfg();
</script>
</body>
</html>
