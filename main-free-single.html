<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–î–æ–º–∏–Ω–æ –ö–ì–ë</title>

<style>
  :root{
    --accent:#e6a8ff;
    --accent2:#ffda8b;
    --tile:#fffaf5;
    --tile-edge:#e2c0ff;
    --tile-shadow:rgba(0,0,0,.25);
    --seat-fs:14px;
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; margin:0; padding:0; }

  body{
    font:500 16px Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    color:#fdf4ff;
    background:#3b281b;
    padding:20px;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  /* ===== STAGE ===== */
  #stage{
    background:#2e2130;
    border-radius:20px;
    padding:20px;
    max-width:1200px;
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    box-shadow:0 0 20px rgba(0,0,0,.5);
  }
  h1{ margin:8px 0 6px; font-size:24px; font-weight:900; color:#f2d39a; }

  /* ===== MENU ===== */
  .menu{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:14px;
    padding:30px;
    z-index:100000;
    background:rgba(0,0,0,.8);
  }
  /* üî• —Å–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
    /* üî• —Å–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
  .menu.hidden {
    display:none !important;
    visibility:hidden !important;
    opacity:0 !important;
    pointer-events:none !important;
  }

  .menu label{ color:#f2d39a; font-weight:800; }
  .menu input{
    padding:8px 12px; width:220px; border-radius:8px; border:2px solid #8c5c2f;
    background:#fff6e7; color:#2b1a10; margin-top:4px;
  }
  .menu button{
    padding:10px 16px; border-radius:10px; border:2px solid #7a5525;
    font-weight:900; cursor:pointer; background:linear-gradient(#f1c97a,#e7b85f); color:#2b1a10;
  }
  /* –∏–º–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±–∏–∫ */
  #nameInputs{ display:flex; flex-direction:column; gap:8px; width:260px; align-items:stretch; }
  .name-row{ display:flex; flex-direction:column; gap:4px; }
  .name-row label{ color:#f2d39a; font-weight:800; font-size:14px; }
  .name-row input{ width:100%; }

  /* ===== HUD ===== */
  .topbar{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 20px; }
  .players{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .player{ padding:6px 12px; border-radius:14px; background:rgba(230,168,255,.15); font-size:12px; }
  .player.active{ background:#f2c56a; color:#2b1a10; font-weight:900; box-shadow:0 0 14px #f2c56a; }
  .controls{ display:flex; gap:8px; }
  .btn{ padding:8px 14px; border-radius:10px; border:2px solid #7a5525; background:linear-gradient(#f1c97a,#e7b85f); color:#2c1a32; font-weight:800; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  #turnInfo{ margin:4px 0 6px; color:#ffda8b; font-weight:800; }

  /* ===== BOARD ===== */
  .board{
    position:relative; width:100%; flex:1; margin:20px 0; border-radius:16px; background:#1f1521;
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 18px rgba(0,0,0,.35);
    overflow:hidden; cursor:grab;
  }
  .board.grabbing{ cursor:grabbing; }
  .chain{ position:relative; width:100%; height:100%; }
  #chainZoom{ position:absolute; inset:0; transform-origin:0 0; }

  /* ===== TILES ===== */
  .tile{
    width:200px; height:70px;
    background:linear-gradient(#fffdf8,#fff6e7);
    border:2px solid #e7dbc9; border-radius:12px;
    display:grid; grid-template-columns:1fr 1fr; position:absolute;
    box-shadow:0 2px 6px rgba(0,0,0,.35), inset 0 0 0 2px #e0d3bd;
    overflow:hidden; user-select:none; -webkit-user-drag:element; transition:transform .12s;
  }
  .tile:hover{ transform:scale(1.04); }
  .tile .half{ display:flex; align-items:center; justify-content:center; padding:0 8px; overflow:visible; min-width:0; position:relative; }
  .tile .half:first-child{ border-right:2px solid #d8c8aa; }
  .tile.vert{ width:70px; height:200px; grid-template-columns:1fr; grid-template-rows:1fr 1fr; }
  .tile.vert .half:first-child{ border-right:none; border-bottom:2px solid #d8c8aa; }
.tile b {
  display:block;
  font-weight:900;
  color:#1c1712;
  white-space:nowrap;      /* –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ */
  overflow:hidden;
  text-align:center;
  line-height:1.1;
}
.tile .half img {
  max-width:90%;
  max-height:90%;
  object-fit:contain;
  margin:auto;
  display:block;
  padding:4px; /* –º–æ–∂–Ω–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ */
}
/* ===== –ò–ó–ú–ï–ù–ï–ù–ò–ï #2: –°—Ç–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –ø—Ä–µ–≤—å—é ===== */
#tilePreview .half img {
  width: 250px;
  height: 250px;
  object-fit: contain;
  display: block;
}

  .tile.hand{ transform:scale(.65); transform-origin:left center; cursor:grab; filter:drop-shadow(0 1px 1px rgba(0,0,0,.25)); }
  .tile.hand *{ pointer-events:none; }

  /* ===== PREVIEW ===== */
  #tilePreview .tile{ width:680px!important; height:260px!important; }
 #tilePreview .tile b {
  font-size: 40px;
  font-weight: 900;
  color: #1c1712;
  text-align: center;
  line-height: 1.2;
  white-space: normal;    /* –ø–µ—Ä–µ–Ω–æ—Å */
  word-break: break-word; /* –ø–µ—Ä–µ–Ω–æ—Å –ø–æ —Å–ª–æ–≤–∞–º */
  overflow: auto;         /* —Å–∫—Ä–æ–ª–ª –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–ª–æ */
  max-height: 100%;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
}


#tilePreview .half {
  display:flex;
  justify-content:center;
  align-items:center;
}

  /* ===== HAND ===== */
  .hands{ width:100%; display:flex; flex-direction:column; gap:10px; padding:10px 0 20px; }
  .hand-header{ width:100%; text-align:center; font-weight:900; color:#e9d2a2; }
  .tray{ width:100%; height:60px; display:flex; gap:8px; align-items:center; overflow-x:auto; padding:8px 10px; border:2px solid #8c5c2f; background:#5a3b21; border-radius:12px; }
  .tray>.tile{ position:static; }

  /* ===== DROP ZONES ===== */
  /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ü–µ–Ω—Ç—Ä–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –ø–æ–ª–µ (–±–µ–∑ –¥—Ä–∞–≥–∞) */
.center-hint{
  position:absolute;
  width:38px; height:38px;
  border:2px dashed #b68a3e;
  border-radius:10px;
  background:rgba(255,215,120,.08);
  display:none;
  z-index:5000;
}
.center-hint::after{
  content:'‚óè';
  font-size:11px; color:#2c1a32; font-weight:900;
  background:#f2c56a; padding:2px 6px; border-radius:8px;
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
}

  .dz{ position:absolute; width:38px; height:38px; border:2px dashed #b68a3e; border-radius:10px; display:none; background:rgba(255,215,120,.08); }
  .dz.active{ display:block; background:rgba(255,215,120,.28); box-shadow:0 0 16px rgba(255,215,120,.7); }
  .dz::after{ content:attr(data-dir); font-size:11px; color:#2c1a32; font-weight:900; background:#f2c56a; padding:2px 6px; border-radius:8px; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }

  /* ===== WIN OVERLAY ===== */
  .final-overlay{ position:absolute; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:100000; }
  .final-message{ font-size:42px; font-weight:900; color:#ffe97f; }
</style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<div id="stage">
  <h1 id="title">Domino ¬∑ –ö–ì–ë</h1>

  <div id="menu" class="menu">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:
      <input type="number" id="playerCount" min="2" max="4" value="2">
    </label>
    <div id="nameInputs"></div>
    <button id="startBtn" type="button">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  </div>

  <div class="topbar">
    <div id="playersBar" class="players"></div>
 <div class="controls">
  <button id="drawBtn" class="btn">–í–∑—è—Ç—å</button>
  <button id="undoBtn" class="btn">–û—Ç–º–µ–Ω–∞</button>
  <button id="endBtn" class="btn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
  <button id="restartBtn" class="btn">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
</div>
  </div>
  <div id="turnInfo"></div>

  <div class="board" id="board">
    <div class="chain" id="chain">
      <div id="chainZoom"></div>
    </div>
  </div>

  <div class="hands">
    <div id="handHeader" class="hand-header"></div>
    <div id="tray" class="tray"></div>
  </div>

 <div id="finalOverlay" class="final-overlay">
  <div class="final-message">üéâ –ü–æ–±–µ–¥–∏–ª–∞ –¥—Ä—É–∂–±–∞! üéâ</div>
</div>
</div>

<div id="tilePreview"
     style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:999999; background:rgba(0,0,0,.6)">
  <div id="tilePreviewInner"></div>
</div>
<canvas id="fireworksCanvas" style="position:fixed; inset:0; z-index:1000000; pointer-events:none; display:none;"></canvas>
<audio id="winSound" src="win.mp3" preload="auto"></audio>
<audio id="sDraw"  src="draw.mp3"  preload="auto"></audio>
<audio id="sPick"  src="pick.mp3"  preload="auto"></audio>
<audio id="sPlace" src="place.mp3" preload="auto"></audio>
  <audio id="sClick" src="click.mp3" preload="auto"></audio>

<script>
/* ===========================================================================================
   Utils & State
=========================================================================================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function uid(){ return Math.random().toString(36).slice(2,9); }
function br(){ return { w:chainEl.clientWidth, h:chainEl.clientHeight }; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function getQueryData(){
  const raw=new URLSearchParams(location.search).get('data');
  if(!raw) return null;
  try{ return JSON.parse(decodeURIComponent(raw)); }
  catch(e){ return null; }
}

/* constants */
const TILE_W=200, TILE_H=70, VERT_W=70, VERT_H=200, GAP=4, DZ=38;

/* DOM refs */
const menuEl=document.getElementById('menu');
const nameInputsEl=document.getElementById('nameInputs');
const playerCountEl=document.getElementById('playerCount');
const startBtn=document.getElementById('startBtn');

const playersBarEl=document.getElementById('playersBar');
const boardEl=document.getElementById('board');
const chainEl=document.getElementById('chain');
const chainZoom=document.getElementById('chainZoom');

const handHeader=document.getElementById('handHeader');
const trayEl=document.getElementById('tray');

const drawBtn=document.getElementById('drawBtn');
const restartBtn=document.getElementById('restartBtn');
const turnInfo=document.getElementById('turnInfo');
const deckInfo = document.createElement('div');
deckInfo.style.marginLeft = 'auto';
deckInfo.style.fontWeight = '800';
deckInfo.style.color = '#ffda8b';
document.querySelector('.topbar').appendChild(deckInfo);

const previewWrap=document.getElementById('tilePreview');
const previewInner=document.getElementById('tilePreviewInner');
  // sounds
const sDraw  = document.getElementById('sDraw');
const sPick  = document.getElementById('sPick');
const sPlace = document.getElementById('sPlace');
  const sClick = document.getElementById('sClick');

function play(a){ if(a){ a.currentTime = 0; a.play().catch(()=>{}); } }
// –¶–µ–Ω—Ç—Ä-—Ö–∏–Ω—Ç (–ø–æ–¥—Å–∫–∞–∑–∫–∞ ¬´—Ç–æ—á–∫–∏¬ª –±–µ–∑ –¥—Ä–∞–≥–∞)
const centerHint = document.createElement('div');
centerHint.className = 'center-hint';
chainZoom.appendChild(centerHint);

function showCenterHintIfEmpty(){
  const placed = chainZoom.querySelector('.tile:not(.hand)');
  if(placed){ centerHint.style.display='none'; return; }
  const sx = Math.floor((br().w - TILE_W)/2);
  const sy = Math.floor((br().h - TILE_H)/2);
  centerHint.style.left = (sx + TILE_W/2 - 38/2) + 'px';
  centerHint.style.top  = (sy + TILE_H/2 - 38/2) + 'px';
  centerHint.style.display = 'block';
}
function hideCenterHint(){ centerHint.style.display='none'; }

/* Game state */
let playerNames=[], hands={}, deck=[], currentPlayer=0, passes={};
let dragging = null;   // <‚Äî –¥–æ–±–∞–≤–∏—Ç—å
let history = [];      // <‚Äî —É–∂–µ –µ—Å—Ç—å –Ω–∏–∂–µ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–µ—Ä–∂–∞—Ç—å —Ä—è–¥–æ–º –∏ –æ–¥–∏–Ω —Ä–∞–∑
  let endLeft = null, endRight = null;   // –∫–æ–Ω—Ü—ã —Ü–µ–ø–æ—á–∫–∏
const DZ_SZ = DZ;                      // —Ä–∞–∑–º–µ—Ä –∑–æ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º DZ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç)
  let openLeft = null, openRight = null;  // –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ü–æ–≤ (–Ω–∞ –±—É–¥—É—â–µ–µ)
/* ===========================================================================================
   Pan & Zoom
=========================================================================================== */
let scale=1, panX=0, panY=0, isPanning=false, startPanX=0, startPanY=0;
function updateTransform(){ chainZoom.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; }

boardEl.addEventListener('mousedown', e=>{
  if(e.button!==0 || e.target.closest('.dz, .tile')) return;
  e.preventDefault();
  isPanning=true;
  startPanX=e.clientX - panX;
  startPanY=e.clientY - panY;
  boardEl.classList.add('grabbing');
});
window.addEventListener('mousemove', e=>{
  if(!isPanning) return;
  e.preventDefault();
  panX = e.clientX - startPanX;
  panY = e.clientY - startPanY;
  updateTransform();
});
window.addEventListener('mouseup', ()=>{
  if(isPanning){ isPanning=false; boardEl.classList.remove('grabbing'); }
});
boardEl.addEventListener('wheel', e=>{
  e.preventDefault();
  const rect=boardEl.getBoundingClientRect();
  const mouseX=e.clientX - rect.left;
  const mouseY=e.clientY - rect.top;
  const newScale = clamp(scale * (1 - e.deltaY * 0.001), 0.2, 2.5);
  panX = mouseX - (mouseX - panX) * (newScale / scale);
  panY = mouseY - (mouseY - panY) * (newScale / scale);
  scale = newScale;
  updateTransform();
});
// –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ü–µ–Ω—Ç—Ä–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –ø—É—Å—Ç—É—é –¥–æ—Å–∫—É
boardEl.addEventListener('mouseenter', showCenterHintIfEmpty);
boardEl.addEventListener('mouseleave', hideCenterHint);
window.addEventListener('resize', showCenterHintIfEmpty);
/* ===========================================================================================
   Menu inputs (players)
=========================================================================================== */
function renderNameInputs(){
  nameInputsEl.innerHTML='';
  const c=parseInt(playerCountEl.value,10)||2;
  for(let i=0;i<c;i++){
    const row=document.createElement('div');
    row.className='name-row';
    const lab=document.createElement('label');
    lab.textContent='–ò–º—è –∏–≥—Ä–æ–∫–∞ '+(i+1);
    const inp=document.createElement('input');
    inp.placeholder='–ò–º—è –∏–≥—Ä–æ–∫–∞ '+(i+1);
    inp.id='pname'+i;
    row.appendChild(lab);
    row.appendChild(inp);
    nameInputsEl.appendChild(row);
  }
}
playerCountEl.addEventListener('input',renderNameInputs);
renderNameInputs();

/* ===========================================================================================
   Big Preview
=========================================================================================== */
function fitPreviewText(wordEl, container) {
  if (!wordEl) return null;

  wordEl.style.lineHeight = "1.1";
  wordEl.style.whiteSpace = "nowrap"; // –ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
  let best = 20;

  for (let s = 150; s >= 20; s--) {
    wordEl.style.fontSize = s + "px";
    const fits = wordEl.scrollWidth <= container.clientWidth - 8 &&
                 wordEl.scrollHeight <= container.clientHeight - 8;
    if (fits) {
      best = s; // –Ω–∞—à–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–∞–∑–º–µ—Ä
    }
  }

  // –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –¥–∞–∂–µ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º (20px) —Ç–µ–∫—Å—Ç –Ω–µ –≤–ª–µ–∑
  wordEl.style.fontSize = best + "px";
  const stillTooBig = wordEl.scrollWidth > container.clientWidth - 8;

  if (stillTooBig) {
    // –≤–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å
    wordEl.style.whiteSpace = "normal";
    wordEl.style.wordBreak = "break-word";
  }

  return best;
}

function showPreview(a, b){
  previewInner.innerHTML = "";
  const big = document.createElement("div");
  big.className = "tile";
  big.style.position = "static";
  big.style.width = "680px"; 
  big.style.height = "260px";
  big.innerHTML = '<div class="half"></div><div class="half"></div>';
  previewInner.appendChild(big);

  const halfL = big.querySelector(".half:first-child");
  const halfR = big.querySelector(".half:last-child");
  const isImg = v=>/^https?:\/\/.+\.(png|jpg|jpeg|gif|svg|webp)$/i.test(v);

 function renderHalf(container, value){
  container.innerHTML="";
  if(isImg(value)){ 
    const img=document.createElement('img'); 
    img.src=value; 
    container.appendChild(img); 
  } else {
   const textEl=document.createElement('b'); 
textEl.innerHTML = `<span class="math">${value}</span>`; 
textEl.style.fontSize = "40px"; 
    textEl.style.wordBreak = "break-word"; 
    textEl.style.whiteSpace = "normal"; 
    textEl.style.overflow = "auto"; 
    textEl.style.display = "flex";
    textEl.style.alignItems = "center";
    textEl.style.justifyContent = "center";
    container.appendChild(textEl); 
    if (window.MathJax) MathJax.typesetPromise([textEl]);
  }
}


  renderHalf(halfL, a);
  renderHalf(halfR, b);

  previewWrap.style.display='flex';
}

function hidePreview(){ previewWrap.style.display='none'; }
previewWrap.addEventListener('click',hidePreview);
addEventListener('keydown',e=>{ if(e.key==='Escape') hidePreview(); });

/* ===========================================================================================
   Tile factory (DOM)
=========================================================================================== */
function createTileEl(a,b,opts={}){
  const role=opts.role||'chain';
  const orient=opts.orient||'h';
  const el=document.createElement('div');
  el.className='tile '+(orient==='v'?'vert ':'')+(role==='hand'?'hand':'');
  el.style.left=(opts.left||0)+'px';
  el.style.top=(opts.top||0)+'px';
  el.innerHTML='<div class="half"><b></b></div><div class="half"><b></b></div>';

  const halves=el.getElementsByClassName('half');
function fitToHalf(node, container) {
  if (!node) return 12;

  let best = 12;
  node.style.whiteSpace = "nowrap";  // –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
  node.style.overflow = "hidden";
  node.style.textAlign = "center";

  // —É–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –í–ï–°–¨ —Ç–µ–∫—Å—Ç –Ω–µ –≤–ª–µ–∑–µ—Ç
  for (let s = 40; s >= 8; s--) {
    node.style.fontSize = s + "px";
    const fits =
      node.scrollWidth <= container.clientWidth - 4 &&
      node.scrollHeight <= container.clientHeight - 4;
    if (fits) {
      best = s;
      break;
    }
  }
  return best;
}


  const leftEl = halves[0].firstElementChild;
  const rightEl = halves[1].firstElementChild;
  const isImg=v=>/^https?:\/\/.+\.(png|jpg|jpeg|gif|svg|webp)$/i.test(v);

  function renderHalf(containerEl, value){
    containerEl.innerHTML="";
    if(isImg(value)){
      const img=document.createElement('img'); img.src=value; containerEl.appendChild(img);
      return null;
   }else{
  const b=document.createElement('b'); 
  b.innerHTML = `<span class="math">${value}</span>`;
  containerEl.appendChild(b); 
  if (window.MathJax) MathJax.typesetPromise([b]);
  return b;
}
  }

  const dispA = opts.displayA ?? a;
  const dispB = opts.displayB ?? b;

  const leftNode  = renderHalf(halves[0], dispA);
  const rightNode = renderHalf(halves[1], dispB);

  const leftSize  = leftNode  ? fitToHalf(leftNode,  halves[0]) : 12;
  const rightSize = rightNode ? fitToHalf(rightNode, halves[1]) : 12;
  const finalSize = Math.min(leftSize, rightSize);

  if(role === 'hand'){
    if(leftNode)  leftNode.style.fontSize  = (finalSize * 1.2) + "px";
    if(rightNode) rightNode.style.fontSize = (finalSize * 1.2) + "px";
  } else {
    if(leftNode)  leftNode.style.fontSize  = finalSize + "px";
    if(rightNode) rightNode.style.fontSize = finalSize + "px";
  }

  el.addEventListener('click',()=>showPreview(dispA,dispB));

if(role==='hand'){
  el.draggable=true;
  el.addEventListener('dragstart',e=>{
    hideCenterHint(); // —Å–ø—Ä—è—Ç–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É —Ü–µ–Ω—Ç—Ä–∞
    dragging={
      a:opts.aKey ?? a,
      b:opts.bKey ?? b,
      displayA: dispA,
      displayB: dispB,
      owner:opts.owner,
      uid:opts.uid
    };
        play(sPick); // ‚Üê –∑–≤—É–∫ ¬´–ø–æ–¥–Ω—è–ª–∏ –ø–ª–∏—Ç–∫—É¬ª
    e.dataTransfer.setData('text/plain','domino');
    hidePreview();
    renderDirectionalZones();   // ‚Üê –ü–æ–∫–∞–∑–∞—Ç—å –∑–æ–Ω—ã
  });
  el.addEventListener('dragend',()=>{
    dragging=null;
    clearZones();               // ‚Üê –£–±—Ä–∞—Ç—å –∑–æ–Ω—ã
  });
}
  return el;
}

/* ===========================================================================================
   Collisions
=========================================================================================== */
function rectOf(o,x,y){ return { x, y, w:(o==='v'?VERT_W:TILE_W), h:(o==='v'?VERT_H:TILE_H) }; }
function intersects(r1,r2){ return !(r2.x>=r1.x+r1.w || r2.x+r2.w<=r1.x || r2.y>=r1.y+r1.h || r2.y+r2.h<=r1.y); }
function collidesWithExisting(r){
  for(const t of chainZoom.querySelectorAll('.tile:not(.hand)')){
    const w=t.classList.contains('vert')?VERT_W:TILE_W;
    const h=t.classList.contains('vert')?VERT_H:TILE_H;
    const r2={ x:parseInt(t.style.left||0), y:parseInt(t.style.top||0), w, h };
    if(intersects(r,r2)) return true;
  }
  return false;
}

/* ===========================================================================================
   Ends & positioning
=========================================================================================== */
function getSeam(end){
  if(end.orient==='h'){
    return end.dir===1
      ? {x:end.x + TILE_W,     y:end.y + TILE_H/2}
      : {x:end.x,              y:end.y + TILE_H/2};
  } else {
    return end.dir===1
      ? {x:end.x + VERT_W/2,   y:end.y + VERT_H}
      : {x:end.x + VERT_W/2,   y:end.y};
  }
}
function getNextPos(end, choice){
  let x,y,orient,nextDir;
  if(end.orient==='h'){
    const seamX = end.dir===1 ? end.x + TILE_W : end.x;
    switch(choice){
      case 'right': x=seamX + GAP;           y=end.y;                 orient='h'; nextDir= 1; break;
      case 'left':  x=seamX - TILE_W - GAP;  y=end.y;                 orient='h'; nextDir=-1; break;
      case 'down':  x=seamX - VERT_W/2;      y=end.y + TILE_H + GAP;  orient='v'; nextDir= 1; break;
      case 'up':    x=seamX - VERT_W/2;      y=end.y - VERT_H - GAP;  orient='v'; nextDir=-1; break;
    }
  } else {
    const seamY = end.dir===1 ? end.y + VERT_H : end.y;
    switch(choice){
      case 'up':    x=end.x;                 y=seamY - VERT_H - GAP;  orient='v'; nextDir=-1; break;
      case 'down':  x=end.x;                 y=seamY + GAP;           orient='v'; nextDir= 1; break;
      case 'right': x=end.x + VERT_W + GAP;  y=seamY - TILE_H/2;      orient='h'; nextDir= 1; break;
      case 'left':  x=end.x - TILE_W - GAP;  y=seamY - TILE_H/2;      orient='h'; nextDir=-1; break;
    }
  }
  return { x,y,orient,nextDir };
}
function applyPlaced(end,pos){ end.x=pos.x; end.y=pos.y; end.orient=pos.orient; end.dir=pos.nextDir; }
// ===== Recompute ends from DOM (robust after UNDO) =====
function ensureEndsValid(){
  const tiles = [...chainZoom.querySelectorAll('.tile:not(.hand)')];
  if (tiles.length === 0){ endLeft=null; endRight=null; return; }

  // –µ—Å–ª–∏ –∫–æ–Ω—Ü—ã –≤–∞–ª–∏–¥–Ω—ã –∏ –∏—Ö el –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º
  function isValidEnd(e){
    return e && e.el && e.el.isConnected && typeof e.x==='number' && typeof e.y==='number' && e.orient && (e.dir===1 || e.dir===-1);
  }
  if (isValidEnd(endLeft) && isValidEnd(endRight)) return;

  // –∏–Ω–∞—á–µ: –±–µ—Ä—ë–º –∫—Ä–∞–π–Ω–∏–µ ¬´—à–≤—ã¬ª –≤—Å–µ—Ö –ø–ª–∏—Ç–æ–∫ –∏ –≤—ã–±–∏—Ä–∞–µ–º —Å–∞–º—É—é –ª–µ–≤—É—é –∏ –ø—Ä–∞–≤—É—é —Ç–æ—á–∫–∏
  let candidates = [];
  for (const t of tiles){
    const x = parseInt(t.style.left||0);
    const y = parseInt(t.style.top||0);
    const o = t.classList.contains('vert') ? 'v' : 'h';

    // –¥–≤–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ü–∞ —É –ø–ª–∏—Ç–∫–∏
    const ends = [
      { x, y, orient:o, dir:-1, el:t },                                           // –ª–µ–≤—ã–π/–≤–µ—Ä—Ö–Ω–∏–π –∫–æ–Ω–µ—Ü
      { x, y, orient:o, dir: 1, el:t },                                           // –ø—Ä–∞–≤—ã–π/–Ω–∏–∂–Ω–∏–π –∫–æ–Ω–µ—Ü
    ];
    for(const e of ends){
      const s = getSeam(e);
      candidates.push({ seamX:s.x, seamY:s.y, end:e });
    }
  }
  // –∫—Ä–∞–π–Ω—è—è —Å–ª–µ–≤–∞ –∏ –∫—Ä–∞–π–Ω—è—è —Å–ø—Ä–∞–≤–∞ —Ç–æ—á–∫–∏
  candidates.sort((a,b)=>a.seamX-b.seamX);
  const leftMost  = candidates[0].end;
  const rightMost = candidates[candidates.length-1].end;

  endLeft  = { ...leftMost  };
  endRight = { ...rightMost };
}

/* ===========================================================================================
   Drop zones
=========================================================================================== */
function clearZones(){
  chainZoom.querySelectorAll('.dz').forEach(n=>n.remove());
}
function renderDirectionalZones(){
  clearZones();
  if(!dragging) return;

  ensureEndsValid(); // ‚Üê –∫–ª—é—á–µ–≤–æ–µ: –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ü—ã –ø–µ—Ä–µ–¥ —Ä–∞—Å—á—ë—Ç–æ–º –∑–æ–Ω

  const placed = [...chainZoom.querySelectorAll('.tile:not(.hand)')];
  // –µ—Å–ª–∏ –Ω–∞ –ø–æ–ª–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –ø–ª–∏—Ç–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –∑–æ–Ω—É
  if(placed.length===0){
    const sx = Math.floor((br().w - TILE_W)/2);
    const sy = Math.floor((br().h - TILE_H)/2);

    const z = document.createElement('div');
    z.className = 'dz active';
    z.style.left = (sx + TILE_W/2 - DZ/2) + 'px';
    z.style.top  = (sy + TILE_H/2 - DZ/2) + 'px';
    z.dataset.end = 'C';     // —Ü–µ–Ω—Ç—Ä
    z.dataset.k   = 'right'; // —Å—Ç–∞—Ä—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
z.dataset.dir = '‚óè'; 
    chainZoom.appendChild(z);

    // –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –∫–æ–Ω—Ü—ã (–ø–æ–∫–∞ –±–µ–∑ el)
    endLeft  = { x:sx, y:sy, orient:'h', dir:-1, el:null };
    endRight = { x:sx, y:sy, orient:'h', dir: 1, el:null };
    return;
  }

  // –µ—Å–ª–∏ –∫–æ–Ω—Ü—ã –µ—â—ë –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã ‚Äî –≤–æ–∑—å–º—ë–º –ø–µ—Ä–≤—É—é –ø–ª–∏—Ç–∫—É –Ω–∞ –ø–æ–ª–µ
  const ends = [{e:endLeft,id:'L'}, {e:endRight,id:'R'}];
  for(const side of ends){
    const e = side.e; if(!e) continue;

    const seam = getSeam(e); // —Ç–æ—á–∫–∞ ¬´—à–≤–∞¬ª
  for (const k of ['up','down','left','right']) {
  const pos = getNextPos(e, k);
  if (!pos.orient) continue;

  const r = rectOf(pos.orient, pos.x, pos.y);
  if (collidesWithExisting(r)) continue;

  const z = document.createElement('div');
  z.className = 'dz active';

  // –†–∞–∑–Ω–æ—Å–∏–º –∑–æ–Ω—ã –≤–æ–∫—Ä—É–≥ —à–≤–∞, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å
  if (k === 'up')    { z.style.left = (seam.x - DZ/2) + 'px'; z.style.top = (seam.y - DZ*2) + 'px'; }
  if (k === 'down')  { z.style.left = (seam.x - DZ/2) + 'px'; z.style.top = (seam.y + DZ)   + 'px'; }
  if (k === 'left')  { z.style.left = (seam.x - DZ*2) + 'px'; z.style.top = (seam.y - DZ/2) + 'px'; }
  if (k === 'right') { z.style.left = (seam.x + DZ)   + 'px'; z.style.top = (seam.y - DZ/2) + 'px'; }

  z.dataset.end = side.id; // L/R
  z.dataset.k   = k;
  z.dataset.dir = ({up:'‚Üë',down:'‚Üì',left:'‚Üê',right:'‚Üí'})[k]; // –∫—Ä–∞—Å–∏–≤—ã–π –±–µ–π–¥–∂

  chainZoom.appendChild(z);
}
  }
}

/* ===========================================================================================
   Rules / helpers
=========================================================================================== */


/* ===========================================================================================
   Placing / autorotate
=========================================================================================== */
function placeAt(whichEnd,tileData,choice){
  const end=(whichEnd==='left')?endLeft:endRight;
  const pos=getNextPos(end,choice);
  const r=rectOf(pos.orient,pos.x,pos.y);
  if(!pos.orient || collidesWithExisting(r)) return false;

  const newTile = createTileEl(
    tileData.a, tileData.b,
    { orient:pos.orient, left:pos.x, top:pos.y, displayA:tileData.displayA, displayB:tileData.displayB }
  );
  chainZoom.appendChild(newTile);

  applyPlaced(end,pos);
  end.el = newTile;
  return true;
}

/* ===========================================================================================
   Fit chain
=========================================================================================== */
function fitChain(){
  const tiles=[...chainZoom.querySelectorAll('.tile:not(.hand)')];
  if(!tiles.length){ scale=1; panX=0; panY=0; updateTransform(); return; }
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  for(const t of tiles){
    const x=parseInt(t.style.left||0), y=parseInt(t.style.top||0);
    const w=t.classList.contains('vert')?VERT_W:TILE_W;
    const h=t.classList.contains('vert')?VERT_H:TILE_H;
    minX=Math.min(minX,x); minY=Math.min(minY,y);
    maxX=Math.max(maxX,x+w); maxY=Math.max(maxY,y+h);
  }
  const pad=20;
  const s=Math.min(1,(br().w-pad)/(maxX-minX),(br().h-pad)/(maxY-minY));
  scale=s;
  panX=(br().w - (maxX-minX)*s)/2 - minX*s;
  panY=(br().h - (maxY-minY)*s)/2 - minY*s;
  updateTransform();
}
addEventListener('resize', ()=>{ fitChain(); });

/* ===========================================================================================
   UI: players & hand
=========================================================================================== */
function renderPlayersBar() {
  playersBarEl.innerHTML = '';
  for (let i = 0; i < playerNames.length; i++) {
    const el = document.createElement('div');
    el.className = 'player' + (i === currentPlayer ? ' active' : '');
    el.textContent = playerNames[i] || `–ò–≥—Ä–æ–∫ ${i+1}`;
    playersBarEl.appendChild(el);
  }
  playersBarEl.style.display = "flex"; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –≤–∏–¥–Ω–æ
}

function renderHand(){
  handHeader.textContent = `${playerNames[currentPlayer]}: (${(hands[currentPlayer]||[]).length} –∫–æ—Å—Ç—è—à–µ–∫)`;
  trayEl.innerHTML='';
  for(const t of (hands[currentPlayer]||[])){
    const el=createTileEl(
      t.a, t.b,
      { role:'hand', owner:currentPlayer, uid:t.uid, orient:'h', draggable:true, displayA:t.displayA, displayB:t.displayB, aKey:t.a, bKey:t.b }
    );
    trayEl.appendChild(el);
  }
}

function updateControls(){
  [...playersBarEl.getElementsByClassName('player')]
    .forEach((n,idx)=>n.classList.toggle('active',idx===currentPlayer));

  turnInfo.textContent = `–•–æ–¥: ${playerNames[currentPlayer]}`;

  // –æ—Å—Ç–∞—Ç–æ–∫ –∫–æ–ª–æ–¥—ã
  deckInfo.textContent = `–ö–æ–ª–æ–¥–∞: ${deck.length}`;

  // –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —Ñ–∞–∫—Ç—É –Ω–∞–ª–∏—á–∏—è –∫–∞—Ä—Ç
  drawBtn.disabled = deck.length === 0;
}



/* ===========================================================================================
   Fireworks + Sound
=========================================================================================== */
const fwCanvas = document.getElementById('fireworksCanvas');
const fwCtx = fwCanvas.getContext('2d');
const winSound = document.getElementById('winSound');
let fwParticles = []; let fwRunning = false;
function resizeFW(){ fwCanvas.width = window.innerWidth; fwCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeFW); resizeFW();
function launchFirework(){
  const colors = ["#ff4d6d","#ffd93d","#00f5d4","#9d4edd","#f72585","#4cc9f0"];
  const x = Math.random() * fwCanvas.width; const y = Math.random() * fwCanvas.height/2;
  for(let i=0;i<100;i++){
    fwParticles.push({ x, y, angle: Math.random()*2*Math.PI, speed: Math.random()*5+2, life: 100, color: colors[Math.floor(Math.random()*colors.length)] });
  }
}
function updateFW(){
  fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height);
  fwParticles.forEach(p=>{
    p.x += Math.cos(p.angle)*p.speed; p.y += Math.sin(p.angle)*p.speed; p.life -= 2;
    fwCtx.fillStyle = p.color; fwCtx.globalAlpha = Math.max(p.life/100,0);
    fwCtx.beginPath(); fwCtx.arc(p.x,p.y,2,0,Math.PI*2); fwCtx.fill();
  });
  fwParticles = fwParticles.filter(p=>p.life>0);
  if(fwRunning) requestAnimationFrame(updateFW);
}
function startFireworks(){
  fwCanvas.style.display="block"; fwRunning=true;
  if (winSound){ winSound.currentTime = 0; winSound.play().catch(()=>{}); }
  setInterval(launchFirework,600); updateFW();
}

/* ===========================================================================================
   Deck (from data) + default
=========================================================================================== */
function buildDeckFromData(d){
  const out=[];
  const raw = (d && Array.isArray(d.listA)) ? d.listA : [];
  const A = [...new Set(raw)];           // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
  for(let i=0;i+1<A.length;i+=2){        // –ø–æ–ø–∞—Ä–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Å–ª–æ–≤–∞ –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–∞—Ö)
    out.push({ a:i, b:i+1, displayA:A[i], displayB:A[i+1], uid:uid() });
  }
  return out;
}


function makeDefaultDeck(){
  const F=["–∫–æ—Ç","–ø—ë—Å","–ª—É–Ω–∞","—Å–æ–ª–Ω—Ü–µ","–∑–≤–µ–∑–¥–∞","–º–æ—Å—Ç","—Ä–µ–∫–∞","–¥–æ–º","–ª–µ—Å","–º–æ—Ä–µ","—Å–∞–º–æ–ª—ë—Ç"];
  const A=[...new Set(F)];
  const out=[];
  for(let i=0;i+1<A.length;i+=2){
    out.push({ a:i, b:i+1, displayA:A[i], displayB:A[i+1], uid:uid() });
  }
  return out;
}



/* –æ—Ü–µ–Ω–∫–∞ –µ–¥–∏–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ ‚Äî –ø–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º —Å–ª–æ–≤–∞–º/–∫–∞—Ä—Ç–∏–Ω–∫–∞–º (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç) */
function computeUniformSize(deck){
  const words=[];
  for(const t of deck){
    if(typeof t.displayA==='string' && !/^https?:\/\//i.test(t.displayA)) words.push(t.displayA);
    if(typeof t.displayB==='string' && !/^https?:\/\//i.test(t.displayB)) words.push(t.displayB);
  }
  if(!words.length) return;

  const meas=document.createElement('div');
  meas.style.cssText=`position:fixed;left:-9999px;top:-9999px;width:${TILE_W/2-24}px;white-space:nowrap;font-weight:900;font-family:Inter,system-ui,sans-serif;`;
  document.body.appendChild(meas);
  let min=30;
  for(const w of words){
    let s=30; meas.style.fontSize=s+'px'; meas.textContent=w;
    while(s>10 && meas.scrollWidth>meas.clientWidth){ s--; meas.style.fontSize=s+'px'; }
    min=Math.min(min,s);
  }
  document.body.removeChild(meas);
  // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å min –≥–¥–µ-—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–æ ‚Äî –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
}

/* ===========================================================================================
   Game flow
=========================================================================================== */
function nextPlayer(){
  currentPlayer = (currentPlayer + 1) % playerNames.length;
  renderPlayersBar();
  renderHand();
  updateControls();
}
/* ===========================================================================================
   Start game
=========================================================================================== */
function startGame(){
  const n=Math.max(2,Math.min(4,parseInt(playerCountEl.value)||2));

  // names
  playerNames=[];
  for(let i=0;i<n;i++){
    playerNames.push((document.getElementById('pname'+i)?.value||'').trim()||('–ò–≥—Ä–æ–∫ '+(i+1)));
  }

  // deck ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∏–∑ ?data=listA, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç
  const data = getQueryData() || {};
  deck = buildDeckFromData(data);
  if(!deck.length){ deck = makeDefaultDeck(); }
  shuffle(deck);

  // —à—Ä–∏—Ñ—Ç –ø–æ–¥ –≤—Å–µ —Å–ª–æ–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  computeUniformSize(deck);

  // reset hands/pass
  hands={}; passes={}; currentPlayer=0;
  for(let i=0;i<n;i++){ hands[i]=[]; passes[i]=0; }
history = []; // —Å–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–∞—Ä—Ç–∏–π
  // —Ä–∞–∑–¥–∞—á–∞ 7 –∫–æ—Å—Ç—è—à–µ–∫
 // —Ä–∞–∑–¥–∞—á–∞: –Ω–µ –±–æ–ª—å—à–µ, —á–µ–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–ª–æ–¥–∞
const MAX_HAND = 7;
const perPlayer = Math.min(
  MAX_HAND,
  Math.floor(deck.length / n)  // —á–µ—Å—Ç–Ω–æ –¥–µ–ª–∏–º –∫–æ–ª–æ–¥—É –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏
);
for (let r = 0; r < perPlayer; r++) {
  for (let i = 0; i < n; i++) {
    if (!deck.length) break;
    hands[i].push(deck.shift());
  }
}


  // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –Ω–∞ –ø–æ–ª–µ
chainZoom.innerHTML='';
const sx=Math.floor((br().w-TILE_W)/2);
const sy=Math.floor((br().h-TILE_H)/2);
  // –≤–µ—Ä–Ω—É—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É —Ü–µ–Ω—Ç—Ä–∞ –Ω–∞ –ø—É—Å—Ç–æ–º –ø–æ–ª–µ
chainZoom.appendChild(centerHint);
showCenterHintIfEmpty();
// –∫–æ–Ω—Ü—ã –ø–æ–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã
openLeft=null; openRight=null; endLeft=null; endRight=null;
renderPlayersBar();
renderHand();
updateControls();
fitChain();

  // --- –ñ–Å–°–¢–ö–û–ï —Å–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é ---
  menuEl.classList.add('hidden');
  menuEl.setAttribute('aria-hidden', 'true');
  menuEl.style.display = 'none';
  menuEl.style.visibility = 'hidden';
  menuEl.style.opacity = '0';
  menuEl.style.pointerEvents = 'none';
  // ----------------------------

  document.getElementById('title').textContent = 'Domino ¬∑ –ö–ì–ë';
}

/* ===========================================================================================
   Buttons & DnD
=========================================================================================== */
drawBtn.addEventListener('click', ()=>{
  const hand = hands[currentPlayer] || [];
  if (!deck.length) return;
  hand.push(deck.shift());
   play(sDraw); // ‚Üê –∑–≤—É–∫ ¬´–≤–∑—è–ª–∏ –∏–∑ –∫–æ–ª–æ–¥—ã¬ª
  hands[currentPlayer] = hand;
  renderHand();
  updateControls();
});

document.getElementById("undoBtn").addEventListener("click", ()=>{
  const last = history.pop();
  if(!last) return;

  // 1) —É–±—Ä–∞—Ç—å —Å –ø–æ–ª—è –≤—ã–ª–æ–∂–µ–Ω–Ω—É—é –ø–ª–∏—Ç–∫—É
  if(last.el && last.el.parentNode){
    last.el.parentNode.removeChild(last.el);
  }
// –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –ø–æ–ª–µ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –ø–ª–∏—Ç–æ–∫ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É —Ü–µ–Ω—Ç—Ä–∞
if (!chainZoom.querySelector('.tile:not(.hand)')) {
  endLeft = endRight = null;
  showCenterHintIfEmpty();
}
  // 2) –≤–µ—Ä–Ω—É—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ü–æ–≤, –∫–∞–∫ –±—ã–ª–æ –î–û —Ö–æ–¥–∞
  // (–µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –ø–µ—Ä–≤–∞—è –ø–ª–∏—Ç–∫–∞ ‚Äî prevEnds.left/right –±—É–¥—É—Ç null)
  if (last.prevEnds) {
    endLeft  = last.prevEnds.left  ? { ...last.prevEnds.left  } : null;
    endRight = last.prevEnds.right ? { ...last.prevEnds.right } : null;
  } else {
    endLeft = endRight = null;
  }

  // 3) –≤–µ—Ä–Ω—É—Ç—å –ø–ª–∏—Ç–∫—É –≤ —Ä—É–∫—É —Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –∫—Ç–æ —Ö–æ–¥–∏–ª
  hands[last.player].push({
    a: last.tile.a,
    b: last.tile.b,
    displayA: last.tile.displayA,
    displayB: last.tile.displayB,
    uid: last.tile.uid
  });

  // 4) –≤–µ—Ä–Ω—É—Ç—å —Ö–æ–¥ —ç—Ç–æ–º—É –∏–≥—Ä–æ–∫—É (–≤–∞–∂–Ω–æ!)
  currentPlayer = last.player;

  // 5) –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å—ë –∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
  renderPlayersBar();
  renderHand();
  updateControls();

  // –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ü—ã –ø–æ DOM
  ensureEndsValid();

  clearZones();
  renderDirectionalZones();
});

document.getElementById("endBtn").addEventListener("click", ()=>{
  document.getElementById("finalOverlay").style.display = "flex";
  startFireworks(); // ‚Üê –∑–∞–ø—É—Å–∫ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∞ –∏ win.mp3
});


restartBtn.addEventListener('click', ()=>location.reload());
startBtn.addEventListener('click', startGame);
// –ï–¥–∏–Ω—ã–π –∫–ª–∏–∫-–∑–≤—É–∫ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫, –∫—Ä–æ–º–µ "–í–∑—è—Ç—å" (—É –Ω–µ—ë —Å–≤–æ–π –∑–≤—É–∫ sDraw)
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  if(btn.id === 'drawBtn') return; // —É —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–≤—É–∫
  play(sClick);
});
addEventListener('dragover', e=>{ if(dragging) e.preventDefault(); });

addEventListener('drop', e=>{
  if(!dragging) return;
  const t = e.target;
  if(!(t && t.classList && t.classList.contains('dz'))) return; // –∫–∏–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –∑–æ–Ω—É
  e.preventDefault();

  const isCenter = t.dataset.end === 'C';
  const isLeft   = t.dataset.end === 'L';
  const choice   = t.dataset.k;

  let placedEl = null;

  if(isCenter){
    // –ü–µ—Ä–≤–∞—è –ø–ª–∏—Ç–∫–∞ ‚Äî –≤ —Ü–µ–Ω—Ç—Ä
    const sx = Math.floor((br().w - TILE_W)/2);
    const sy = Math.floor((br().h - TILE_H)/2);
    placedEl = createTileEl(dragging.a, dragging.b,
      { left:sx, top:sy, orient:'h', displayA:dragging.displayA, displayB:dragging.displayB });
    chainZoom.appendChild(placedEl);
    hideCenterHint();
    endLeft  = { x:sx, y:sy, orient:'h', dir:-1, el:placedEl };
endRight = { x:sx, y:sy, orient:'h', dir: 1, el:placedEl };
  } else {
    const end = isLeft ? endLeft : endRight;
    const pos = getNextPos(end, choice);
    if(!pos.orient || collidesWithExisting(rectOf(pos.orient,pos.x,pos.y))) {
      dragging=null; clearZones(); return;
    }
    placedEl = createTileEl(dragging.a, dragging.b,
      { left:pos.x, top:pos.y, orient:pos.orient, displayA:dragging.displayA, displayB:dragging.displayB });
    chainZoom.appendChild(placedEl);
    applyPlaced(end, pos);
    end.el = placedEl;
  }
play(sPlace); // ‚Üê –∑–≤—É–∫ ¬´–ø–æ–ª–æ–∂–∏–ª–∏ –ø–ª–∏—Ç–∫—É –Ω–∞ —Å—Ç–æ–ª¬ª
  // —É–±—Ä–∞—Ç—å –∏–∑ —Ä—É–∫–∏
  const arr = hands[dragging.owner] || [];
  hands[dragging.owner] = arr.filter(x=>x.uid !== dragging.uid);
  renderHand();
// –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∫–æ—Å—Ç—è—à–∫–∏ ‚Äî –ø–æ–±–µ–¥–∞
if ((hands[dragging.owner] || []).length === 0) {
  document.getElementById("finalOverlay").style.display = "flex";
  startFireworks(); // –∑–≤—É–∫ + —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ –ø–æ —Ä–µ–∞–ª—å–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é –ø–æ–±–µ–¥—ã
}
  // –∏—Å—Ç–æ—Ä–∏—è (–¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ Undo)
function cloneEnd(e){
  if(!e) return null;
  return { x:e.x, y:e.y, orient:e.orient, dir:e.dir, el:e.el };
}
history.push({
  type: 'place',
  player: dragging.owner,
  tile: { ...dragging },   // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–ª–∏—Ç–∫–∏
  el: placedEl,
  // —Å–Ω–∏–º–æ–∫ –∫–æ–Ω—Ü–æ–≤ –¥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ—Å—Ç—è—à–∫–∏
  prevEnds: {
    left:  cloneEnd(endLeft),
    right: cloneEnd(endRight)
  }
});


  dragging = null;
  updateControls();
  clearZones();
  renderDirectionalZones(); // –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–µ–∂–∏–µ –∑–æ–Ω—ã
  nextPlayer();
});
addEventListener('mousemove', ()=>{ if(dragging) renderDirectionalZones(); });
/* Safety init */
(function(){
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ renderNameInputs(); });
  } else {
    renderNameInputs();
  }
})();
</script>
</body>
</html>
