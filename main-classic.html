<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Domino ¬∑ Classic</title>

<style>
  :root{
    --accent:#e6a8ff;
    --accent2:#ffda8b;
    --tile:#fffaf5;
    --tile-edge:#e2c0ff;
    --tile-shadow:rgba(0,0,0,.25);
    --seat-fs:14px;
  }

  *{ box-sizing:border-box; }

  html, body{
    height:100%;
    margin:0;
    padding:0;
  }

  body{
    font:500 16px Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    color:#fdf4ff;
    background:#3b281b;
    overflow:hidden;
  }

  /* ===== STAGE ===== */
  #stage{
    position:relative;
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  h1{
    margin:8px 0 6px;
    font-size:24px;
    font-weight:900;
    color:#f2d39a;
  }

  /* ===== MENU ===== */
  .menu{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:14px;
    padding:30px;
    z-index:100000;
    background:rgba(0,0,0,.8);
  }
  .menu label{ color:#f2d39a; font-weight:800; }
  .menu input{
    padding:8px 12px;
    width:220px;
    border-radius:8px;
    border:2px solid #8c5c2f;
    background:#fff6e7;
    color:#2b1a10;
    margin-top:4px;
  }
  .menu button{
    padding:10px 16px;
    border-radius:10px;
    border:2px solid #7a5525;
    font-weight:900;
    cursor:pointer;
    background:linear-gradient(#f1c97a,#e7b85f);
    color:#2b1a10;
  }

  /* ===== HUD ===== */
  .topbar{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:0 10px;
  }
  .players{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .player{
    padding:6px 12px;
    border-radius:14px;
    background:rgba(230,168,255,.15);
    font-size:12px;
  }
  .player.active{
    background:#f2c56a;
    color:#2b1a10;
    font-weight:900;
    box-shadow:0 0 14px #f2c56a;
  }
  .controls{ display:flex; gap:8px; }
  .btn{
    padding:8px 14px;
    border-radius:10px;
    border:2px solid #7a5525;
    background:linear-gradient(#f1c97a,#e7b85f);
    color:#2c1a32;
    font-weight:800;
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  #turnInfo{ margin:4px 0 6px; color:#ffda8b; font-weight:800; }

  /* ===== BOARD ===== */
  .board{
    position:relative;
    width:100%;
    flex:1;
    margin:6px 0;
    background:#2e2130;
    overflow:hidden;
    cursor:grab;
    border-radius:16px;
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 18px rgba(0,0,0,.35);
  }
  .board.grabbing{ cursor:grabbing; }
  .chain{ position:relative; width:100%; height:100%; }
  #chainZoom{ position:absolute; inset:0; transform-origin:0 0; }

  /* ===== TILES ===== */
  .tile{
    width:200px;
    height:70px;
    background:linear-gradient(#fffdf8,#fff6e7);
    border:2px solid #e7dbc9;
    border-radius:12px;
    display:grid;
    grid-template-columns:1fr 1fr;
    position:absolute;
    box-shadow:0 2px 6px rgba(0,0,0,.35), inset 0 0 0 2px #e0d3bd;
    overflow:hidden;
    user-select:none;
    -webkit-user-drag:element;
    transition:transform .12s;
  }
  .tile:hover{ transform:scale(1.04); }
  .tile .half{
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 8px;
    overflow:visible; 
    min-width:0;
    position:relative;
  }
  .tile .half:first-child{ border-right:2px solid #d8c8aa; }
  .tile.vert{
    width:70px;
    height:200px;
    grid-template-columns:1fr;
    grid-template-rows:1fr 1fr;
  }
  .tile.vert .half:first-child{
    border-right:none;
    border-bottom:2px solid #d8c8aa;
  }
  .tile b{
    display:block;
    line-height:1.05;
    font-weight:900;
    color:#1c1712;
    white-space:nowrap;
    max-width:100%;
}
/* –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–æ–≤–∏–Ω–æ–∫ —Ç–∞–π–ª–∞: –ø–æ–ª–µ, —Ä—É–∫–∞ –∏ –ø—Ä–µ–≤—å—é */
.tile .half img {
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  padding: 1px;          /* ‚Üê —Ä–æ–≤–Ω—ã–π –∑–∞–∑–æ—Ä */
  object-fit: contain;   /* ‚Üê –Ω–µ –æ–±—Ä–µ–∑–∞–µ–º */
  display: block;
}
/* ===== PREVIEW TILE ===== */
#tilePreview .tile {
  width: 680px !important;
  height: 260px !important;
}
#tilePreview .tile b {
  font-size: inherit;   /* —Ä–∞–∑–º–µ—Ä –±–µ—Ä—ë—Ç –∏–∑ JS */
  text-align: center;
  white-space: normal;  /* –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω */
  word-break: keep-all; /* –Ω–µ —Ä–≤—ë–º —Å–ª–æ–≤–∞ */
}
#tilePreview .half img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  display: block;
  margin: auto;
}
  .tile.hand{
    transform:scale(.65);
    transform-origin:left center;
    cursor:grab;
    filter:drop-shadow(0 1px 1px rgba(0,0,0,.25));
  }
  .tile.hand *{ pointer-events:none; }

  /* ===== HAND ===== */
  .hands{
    width:100%;
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:8px 0;
  }
  .hand-header{
    width:100%;
    text-align:center;
    font-weight:900;
    color:#e9d2a2;
  }
  .tray{
    width:100%;
    height:60px;
    display:flex;
    gap:8px;
    align-items:center;
    overflow-x:auto;
    padding:8px 10px;
    border:2px solid #8c5c2f;
    background:#5a3b21;
    border-radius:12px;
  }
  .tray > .tile{ position:static; }

  /* ===== DROP ZONES ===== */
  .dz{
    position:absolute;
    width:38px;
    height:38px;
    border:2px dashed #b68a3e;
    border-radius:10px;
    display:none;
    background:rgba(255,215,120,.08);
  }
  .dz.active{
    display:block;
    background:rgba(255,215,120,.28);
    box-shadow:0 0 16px rgba(255,215,120,.7);
  }
  .dz::after{
    content:attr(data-dir);
    font-size:11px;
    color:#2c1a32;
    font-weight:900;
    background:#f2c56a;
    padding:2px 6px;
    border-radius:8px;
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
  }

  /* ===== WIN OVERLAY ===== */
  .final-overlay{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100000;
  }
  .final-message{
    font-size:42px;
    font-weight:900;
    color:#ffe97f;
  }
  body {
  padding: 20px;         /* –æ–±—â–∏–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤ */
  background: #3b281b;   /* —Ñ–æ–Ω –±–µ–∑ —á—ë—Ä–Ω—ã—Ö –ø–æ–ª–æ—Å */
}

#stage {
  max-width: 1200px;     /* –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
  margin: 0 auto;        /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
}

.board {
  margin: 20px 0;        /* –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É */
  border-radius: 20px;   /* —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
}
</style>
</head>
<body>

<div id="stage">
  <h1 id="title">Domino ¬∑ Classic</h1>

  <div id="menu" class="menu">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: <input type="number" id="playerCount" min="2" max="4" value="2"></label>
    <div id="nameInputs"></div>
    <button id="startBtn" type="button">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  </div>

  <div class="topbar">
    <div id="playersBar" class="players"></div>
    <div class="controls">
      <button id="drawBtn" class="btn">–í–∑—è—Ç—å</button>
      <button id="skipBtn" class="btn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="restartBtn" class="btn">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
  </div>
  <div id="turnInfo"></div>

  <div class="board" id="board">
    <div class="chain" id="chain">
      <div id="chainZoom"></div>
    </div>
  </div>

  <div class="hands">
    <div id="handHeader" class="hand-header"></div>
    <div id="tray" class="tray"></div>
  </div>

  <div id="finalOverlay" class="final-overlay">
    <div class="final-message">üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <span id="winnerName"></span> üéâ</div>
  </div>
</div>

<div id="tilePreview"
     style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:999999; background:rgba(0,0,0,.6)">
  <div id="tilePreviewInner"></div>
</div>
  <canvas id="fireworksCanvas"
        style="position:fixed; inset:0; z-index:1000000; pointer-events:none; display:none;"></canvas>
<audio id="winSound" src="win.mp3" preload="auto"></audio>
<script>
  
/* ===========================================================================================
   Utils & State
=========================================================================================== */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function uid(){ return Math.random().toString(36).slice(2,9); }
function br(){ return { w:chainEl.clientWidth, h:chainEl.clientHeight }; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function getQueryData(){
  const raw=new URLSearchParams(location.search).get('data');
  if(!raw) return null;
  try{ return JSON.parse(decodeURIComponent(raw)); }
  catch(e){ return null; }
}

/* constants */
const TILE_W=200, TILE_H=70, VERT_W=70, VERT_H=200, GAP=4, DZ=38;
let uniformTileFontSize = 22;

/* DOM refs */
const menuEl=document.getElementById('menu');
const nameInputsEl=document.getElementById('nameInputs');
const playerCountEl=document.getElementById('playerCount');
const startBtn=document.getElementById('startBtn');

const playersBarEl=document.getElementById('playersBar');
const boardEl=document.getElementById('board');
const chainEl=document.getElementById('chain');
const chainZoom=document.getElementById('chainZoom');

const handHeader=document.getElementById('handHeader');
const trayEl=document.getElementById('tray');

const drawBtn=document.getElementById('drawBtn');
const skipBtn=document.getElementById('skipBtn');
const restartBtn=document.getElementById('restartBtn');
const turnInfo=document.getElementById('turnInfo');

const previewWrap=document.getElementById('tilePreview');
const previewInner=document.getElementById('tilePreviewInner');

/* Game state */
let playerNames=[], hands={}, deck=[], currentPlayer=0, passes={};
let openLeft=null, openRight=null, endLeft=null, endRight=null, dragging=null;
let freeMode = false; // <--- –¥–æ–±–∞–≤–∏–ª–∏


/* ===========================================================================================
   Pan & Zoom
=========================================================================================== */
let scale=1, panX=0, panY=0, isPanning=false, startPanX=0, startPanY=0;

function updateTransform(){
  chainZoom.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}

boardEl.addEventListener('mousedown', e=>{
  if(e.button!==0 || e.target.closest('.dz, .tile')) return;
  e.preventDefault();
  isPanning=true;
  startPanX=e.clientX - panX;
  startPanY=e.clientY - panY;
  boardEl.classList.add('grabbing');
});

window.addEventListener('mousemove', e=>{
  if(!isPanning) return;
  e.preventDefault();
  panX = e.clientX - startPanX;
  panY = e.clientY - startPanY;
  updateTransform();
});

window.addEventListener('mouseup', ()=>{
  if(isPanning){
    isPanning=false;
    boardEl.classList.remove('grabbing');
  }
});

boardEl.addEventListener('wheel', e=>{
  e.preventDefault();
  const rect=boardEl.getBoundingClientRect();
  const mouseX=e.clientX - rect.left;
  const mouseY=e.clientY - rect.top;
  const newScale = clamp(scale * (1 - e.deltaY * 0.001), 0.2, 2.5);
  panX = mouseX - (mouseX - panX) * (newScale / scale);
  panY = mouseY - (mouseY - panY) * (newScale / scale);
  scale = newScale;
  updateTransform();
});

/* ===========================================================================================
   Menu inputs (players)
=========================================================================================== */
function renderNameInputs(){
  nameInputsEl.innerHTML='';
  const c=parseInt(playerCountEl.value,10)||2;
  for(let i=0;i<c;i++){
    const inp=document.createElement('input');
    inp.placeholder='–ò–º—è –∏–≥—Ä–æ–∫–∞ '+(i+1);
    inp.id='pname'+i;
    nameInputsEl.appendChild(inp);
  }
}
playerCountEl.addEventListener('input',renderNameInputs);
renderNameInputs();

/* ===========================================================================================
   Big Preview (–∫—Ä—É–ø–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ –∫–ª–∏–∫—É)
=========================================================================================== */
function fitPreviewText(wordEl, container) {
  if (!wordEl) return null;
  let best = 20;
  wordEl.style.lineHeight = "1.1";
  wordEl.style.whiteSpace = "nowrap"; // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤

  for (let s = 150; s >= 20; s--) {
    wordEl.style.fontSize = s + "px";
    const fits =
      wordEl.scrollWidth <= container.clientWidth - 20 &&
      wordEl.scrollHeight <= container.clientHeight - 20;
    if (fits) {
      best = s;
      break;
    }
  }
  return best;
}

function showPreview(a, b) {
  previewInner.innerHTML = "";

  const big = document.createElement("div");
  big.className = "tile";
  big.style.position = "static";
  big.style.width = "680px";
  big.style.height = "260px";
  big.innerHTML = '<div class="half"></div><div class="half"></div>';
  previewInner.appendChild(big);

  const halfL = big.querySelector(".half:first-child");
  const halfR = big.querySelector(".half:last-child");

  const isImageRegex = /^https?:\/\/.+\.(png|jpg|jpeg|gif|svg|webp)$/i;

  let textEl_L = null;
  let textEl_R = null;

  function renderHalf(container, value) {
    container.innerHTML = "";
    if (isImageRegex.test(value)) {
      const img = document.createElement("img");
      img.src = value;
      container.appendChild(img);
      return null;
    } else {
      const textEl = document.createElement("b");
      textEl.textContent = value;
      container.appendChild(textEl);
      return textEl;
    }
  }

  textEl_L = renderHalf(halfL, a);
  textEl_R = renderHalf(halfR, b);

  // –ø–æ–¥–±–∏—Ä–∞–µ–º –µ–¥–∏–Ω—ã–π —Ä–∞–∑–º–µ—Ä
  const sizeL = fitPreviewText(textEl_L, halfL);
  const sizeR = fitPreviewText(textEl_R, halfR);

  if (sizeL && sizeR) {
    const finalSize = Math.min(sizeL, sizeR);
    textEl_L.style.fontSize = finalSize + "px";
    textEl_R.style.fontSize = finalSize + "px";
  } else if (sizeL) {
    textEl_L.style.fontSize = sizeL + "px";
  } else if (sizeR) {
    textEl_R.style.fontSize = sizeR + "px";
  }

  previewWrap.style.display = "flex";
}

function hidePreview(){ previewWrap.style.display='none'; }
previewWrap.addEventListener('click',hidePreview);
addEventListener('keydown',e=>{ if(e.key==='Escape') hidePreview(); });

/* ===========================================================================================
   Tile factory (DOM)
=========================================================================================== */
function createTileEl(a,b,opts={}){
  const role=opts.role||'chain';
  const orient=opts.orient||'h';
  const el=document.createElement('div');
  el.className='tile '+(orient==='v'?'vert ':'')+(role==='hand'?'hand':'');
  el.style.left=(opts.left||0)+'px';
  el.style.top=(opts.top||0)+'px';
  el.innerHTML='<div class="half"><b></b></div><div class="half"><b></b></div>';

    const halves=el.getElementsByClassName('half');

  function fitToHalf(wordEl, container){
    let best=10;
    for(let s=40; s>=8; s--){   // –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –æ—Ç –∫—Ä—É–ø–Ω–æ–≥–æ –∫ –º–µ–ª–∫–æ–º—É
      wordEl.style.fontSize = s + "px";
      wordEl.style.lineHeight = "1.1";
      wordEl.style.whiteSpace = "nowrap";
      wordEl.style.textAlign = "center";
      const fits = wordEl.scrollWidth <= container.clientWidth-6 &&
                   wordEl.scrollHeight <= container.clientHeight-4;
      if(fits){
        best=s;
        break;
      }
    }
    return best;
  }

  const leftEl = halves[0].firstElementChild;
  const rightEl = halves[1].firstElementChild;

  function renderHalf(el, value) {
  el.innerHTML = ""; // –æ—á–∏—Å—Ç–∏—Ç—å
  if (/^https?:\/\/.+\.(png|jpg|jpeg|gif|svg|webp)$/i.test(value)) {
    const img = document.createElement("img");
    img.src = value;
    // —Å—Ç–∏–ª–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ CSS (.tile .half img)
    el.appendChild(img);
  } else {
    el.textContent = value;
  }
}

renderHalf(leftEl, a);
renderHalf(rightEl, b);


const leftSize  = fitToHalf(leftEl, halves[0]);
const rightSize = fitToHalf(rightEl, halves[1]);
const finalSize = Math.min(leftSize, rightSize);

if (role === 'hand') {
  leftEl.style.fontSize  = (finalSize * 1.2) + "px";  // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ 20%
  rightEl.style.fontSize = (finalSize * 1.2) + "px";
} else {
  leftEl.style.fontSize = rightEl.style.fontSize = finalSize + "px";
}
  // –∫—Ä—É–ø–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ –∫–ª–∏–∫—É ‚Äî –∏ –Ω–∞ –ø–æ–ª–µ, –∏ –≤ —Ä—É–∫–µ
  el.addEventListener('click',()=>showPreview(a,b));

  if(role==='hand'){
    el.draggable=true;
    el.addEventListener('dragstart',e=>{
      dragging={a,b,owner:opts.owner,uid:opts.uid};
      e.dataTransfer.setData('text/plain','domino');
      hidePreview();          // –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
      renderDirectionalZones();
    });
    el.addEventListener('dragend',()=>{
      dragging=null;
      clearZones();
    });
  }

  return el;
}

/* ===========================================================================================
   Collisions
=========================================================================================== */
function rectOf(o,x,y){
  return { x, y, w:(o==='v'?VERT_W:TILE_W), h:(o==='v'?VERT_H:TILE_H) };
}
function intersects(r1,r2){
  return !(r2.x>=r1.x+r1.w || r2.x+r2.w<=r1.x || r2.y>=r1.y+r1.h || r2.y+r2.h<=r1.y);
}
function collidesWithExisting(r){
  for(const t of chainZoom.querySelectorAll('.tile:not(.hand)')){
    const w=t.classList.contains('vert')?VERT_W:TILE_W;
    const h=t.classList.contains('vert')?VERT_H:TILE_H;
    const r2={ x:parseInt(t.style.left||0), y:parseInt(t.style.top||0), w, h };
    if(intersects(r,r2)) return true;
  }
  return false;
}

/* ===========================================================================================
   Ends & positioning helpers
=========================================================================================== */
function getSeam(end){
  if(end.orient==='h'){
    return end.dir===1
      ? {x:end.x + TILE_W,     y:end.y + TILE_H/2}
      : {x:end.x,              y:end.y + TILE_H/2};
  } else {
    return end.dir===1
      ? {x:end.x + VERT_W/2,   y:end.y + VERT_H}
      : {x:end.x + VERT_W/2,   y:end.y};
  }
}

/* –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º main, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ) */
function getNextPos(end, choice){
  let x,y,orient,nextDir;
  if(end.orient==='h'){
    const seamX = end.dir===1 ? end.x + TILE_W : end.x;
    switch(choice){
      case 'right': x=seamX + GAP;           y=end.y;                 orient='h'; nextDir= 1; break;
      case 'left':  x=seamX - TILE_W - GAP;  y=end.y;                 orient='h'; nextDir=-1; break;
      case 'down':  x=seamX - VERT_W/2;      y=end.y + TILE_H + GAP;  orient='v'; nextDir= 1; break;
      case 'up':    x=seamX - VERT_W/2;      y=end.y - VERT_H - GAP;  orient='v'; nextDir=-1; break;
    }
  } else { // vertical
    const seamY = end.dir===1 ? end.y + VERT_H : end.y;
    switch(choice){
      case 'up':    x=end.x;                 y=seamY - VERT_H - GAP;  orient='v'; nextDir=-1; break;
      case 'down':  x=end.x;                 y=seamY + GAP;           orient='v'; nextDir= 1; break;
      case 'right': x=end.x + VERT_W + GAP;  y=seamY - TILE_H/2;      orient='h'; nextDir= 1; break;
      case 'left':  x=end.x - TILE_W - GAP;  y=seamY - TILE_H/2;      orient='h'; nextDir=-1; break;
    }
  }
  return { x,y,orient,nextDir };
}
function applyPlaced(end,pos){
  end.x=pos.x; end.y=pos.y; end.orient=pos.orient; end.dir=pos.nextDir;
}

/* ===========================================================================================
   Drop zones
=========================================================================================== */
function clearZones(){
  chainZoom.querySelectorAll('.dz').forEach(n=>n.remove());
}

function renderDirectionalZones(){
  clearZones();
  if(!dragging) return;

  const ends=[ {e:endLeft, id:'L', open:openLeft}, {e:endRight, id:'R', open:openRight} ];

  for(const side of ends){
    if(!side.e || !side.e.el) continue;

    // —É —Ç–µ–∫—É—â–µ–π –ø–ª–∏—Ç–∫–∏ –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–∞
    if(!(dragging.a===side.open || dragging.b===side.open)) continue;

    const seam=getSeam(side.e);

    const zones={
      up:    { left:seam.x - DZ/2, top:seam.y - DZ*2, dir:'‚Üë', k:'up'    },
      right: { left:seam.x + DZ,   top:seam.y - DZ/2, dir:'‚Üí', k:'right' },
      down:  { left:seam.x - DZ/2, top:seam.y + DZ,   dir:'‚Üì', k:'down'  },
      left:  { left:seam.x - DZ*2, top:seam.y - DZ/2, dir:'‚Üê', k:'left'  }
    };

    for(const k of Object.keys(zones)){
      const pos=getNextPos(side.e,k);
      if(!pos.orient) continue;
      const r=rectOf(pos.orient,pos.x,pos.y);
      if(collidesWithExisting(r)) continue; // –Ω–µ –¥–∞–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è

      const z=document.createElement('div');
      z.className='dz active';
      z.style.left=zones[k].left+'px';
      z.style.top=zones[k].top+'px';
      z.dataset.dir=zones[k].dir;
      z.dataset.end=side.id;   // 'L' / 'R'
      z.dataset.k=k;           // 'up' | 'down' | 'left' | 'right'
      chainZoom.appendChild(z);
    }
  }
}

/* ===========================================================================================
   Rules / helpers
=========================================================================================== */
function hasPlayable(hand){
  for(const t of hand){
    if(t.a===openLeft || t.b===openLeft || t.a===openRight || t.b===openRight) return true;
  }
  return false;
}

// ================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò ==================
function canPlaceTileAtEnd(tile, end, choice, endOpen){
  if(!end || !end.el) return false;
  const pos = getNextPos(end, choice);
  if(!pos.orient) return false;

  const need = desiredHalfFor(choice); // 'a' | 'b'
  let a = tile.a, b = tile.b;

  if(!(a===endOpen || b===endOpen)) return false;

  if(need==='a'){
    if(a!==endOpen && b===endOpen){ [a,b] = [b,a]; }
  } else {
    if(b!==endOpen && a===endOpen){ [a,b] = [b,a]; }
  }
  if((need==='a' && a!==endOpen) || (need==='b' && b!==endOpen)) return false;

  const r = rectOf(pos.orient, pos.x, pos.y);
  return !collidesWithExisting(r);
}

function hasLegalMove(hand){
  const ends = [
    { e:endLeft,  open:openLeft  },
    { e:endRight, open:openRight }
  ];
  const dirs = ['up','down','left','right'];

  for(const t of hand){
    for(const side of ends){
      for(const k of dirs){
        if(canPlaceTileAtEnd(t, side.e, k, side.open)) return true;
      }
    }
  }
  return false;
}


// –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ –Ω–æ–≤–æ–π –ø–ª–∏—Ç–∫–∏ –¥–æ–ª–∂–Ω–∞ ¬´–∫–∞—Å–∞—Ç—å—Å—è¬ª —à–≤–∞
function desiredHalfFor(choice){
  // right/down ‚Äî —É —à–≤–∞ –¥–æ–ª–∂–Ω–∞ –æ–∫–∞–∑–∞—Ç—å—Å—è 'a' (–ª–µ–≤–∞—è/–≤–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ –Ω–æ–≤–æ–π –ø–ª–∏—Ç–∫–∏)
  // left/up    ‚Äî —É —à–≤–∞ –¥–æ–ª–∂–Ω–∞ –æ–∫–∞–∑–∞—Ç—å—Å—è 'b' (–ø—Ä–∞–≤–∞—è/–Ω–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ –Ω–æ–≤–æ–π –ø–ª–∏—Ç–∫–∏)
  return (choice==='right' || choice==='down') ? 'a' : 'b';
}

/* ===========================================================================================
   Placing / autorotate
=========================================================================================== */
function placeAt(whichEnd,tileData,choice){
  const end=(whichEnd==='left')?endLeft:endRight;
  const pos=getNextPos(end,choice);
  const r=rectOf(pos.orient,pos.x,pos.y);
  if(!pos.orient || collidesWithExisting(r)) return false;

  const newTile = createTileEl(tileData.a, tileData.b, { orient:pos.orient, left:pos.x, top:pos.y });
  chainZoom.appendChild(newTile);

  applyPlaced(end,pos);
  end.el = newTile;
  return true;
}

function tryPlace(target,data){
  if(!data || !target.classList.contains('dz')) return false;

  const isLeft = target.dataset.end==='L';
  const choice = target.dataset.k;
  const endOpen = isLeft ? openLeft : openRight;

  // —Å–æ–≤–ø–∞—Å—Ç—å –¥–æ–ª–∂–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–∞
  if(!(data.a===endOpen || data.b===endOpen)) return false;

  // —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º (a,b), —á—Ç–æ–±—ã –Ω—É–∂–Ω–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –ª–µ–≥–ª–∞ –∫ —à–≤—É, –∞ –≤—Ç–æ—Ä–∞—è —Å—Ç–∞–ª–∞ –Ω–æ–≤—ã–º ¬´–æ—Ç–∫—Ä—ã—Ç—ã–º¬ª
  const need = desiredHalfFor(choice); // 'a' –∏–ª–∏ 'b' –¥–æ–ª–∂–Ω–∞ —Ä–æ–≤–Ω—è—Ç—å—Å—è endOpen
  let a=data.a, b=data.b;

  if(need==='a'){
    if(a!==endOpen && b===endOpen){ [a,b]=[b,a]; }
  } else {
    if(b!==endOpen && a===endOpen){ [a,b]=[b,a]; }
  }

  if((need==='a' && a!==endOpen) || (need==='b' && b!==endOpen)) return false;

  if(placeAt(isLeft?'left':'right', {a,b}, choice)){
    const newOpen = (need==='a') ? b : a;
    if(isLeft) openLeft = newOpen; else openRight = newOpen;
    return true;
  }
  return false;
}

/* ===========================================================================================
   Fit chain
=========================================================================================== */
function fitChain(){
  const tiles=[...chainZoom.querySelectorAll('.tile:not(.hand)')];
  if(!tiles.length){
    scale=1; panX=0; panY=0; updateTransform(); return;
  }
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  for(const t of tiles){
    const x=parseInt(t.style.left||0), y=parseInt(t.style.top||0);
    const w=t.classList.contains('vert')?VERT_W:TILE_W;
    const h=t.classList.contains('vert')?VERT_H:TILE_H;
    minX=Math.min(minX,x);
    minY=Math.min(minY,y);
    maxX=Math.max(maxX,x+w);
    maxY=Math.max(maxY,y+h);
  }
  const pad=20;
  const s=Math.min(1,(br().w-pad)/(maxX-minX),(br().h-pad)/(maxY-minY));
  scale=s;
  panX=(br().w - (maxX-minX)*s)/2 - minX*s;
  panY=(br().h - (maxY-minY)*s)/2 - minY*s;
  updateTransform();
}
addEventListener('resize', ()=>{
  fitChain();
  if(dragging) renderDirectionalZones();
});

/* ===========================================================================================
   UI: players & hand
=========================================================================================== */
function renderPlayersBar(){
  playersBarEl.innerHTML='';
  for(let i=0;i<playerNames.length;i++){
    const el=document.createElement('div');
    el.className='player'+(i===currentPlayer?' active':'');
    el.textContent=playerNames[i];
    playersBarEl.appendChild(el);
  }
}

function renderHand(){
  handHeader.textContent = `${playerNames[currentPlayer]}: (${(hands[currentPlayer]||[]).length} –∫–æ—Å—Ç—è—à–µ–∫)`;
  trayEl.innerHTML='';
  for(const t of (hands[currentPlayer]||[])){
    const el=createTileEl(t.a,t.b,{ role:'hand', owner:currentPlayer, uid:t.uid, orient:'h', draggable:true });
    trayEl.appendChild(el);
  }
}

function updateControls(){
¬† [...playersBarEl.getElementsByClassName('player')]
¬† ¬† .forEach((n,idx)=>n.classList.toggle('active',idx===currentPlayer));

¬† turnInfo.textContent = `–•–æ–¥: ${playerNames[currentPlayer]}`;
¬† const currentHand = hands[currentPlayer] || [];
¬† const playable = hasPlayable(currentHand);

¬† // ‚úÖ –ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∫–æ—Å—Ç—è—à–µ–∫ –ò –≤ –∫–æ–ª–æ–¥–µ –ï–°–¢–¨ –∫–æ—Å—Ç—è—à–∫–∏.
¬† drawBtn.disabled = playable || deck.length === 0;

¬† // ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∫–æ—Å—Ç—è—à–µ–∫ –ò –∫–æ–ª–æ–¥–∞ –ü–£–°–¢–ê.
¬† skipBtn.disabled = playable || deck.length > 0;
}
/* ===========================================================================================
   Game flow
=========================================================================================== */
function nextPlayer(){
  currentPlayer=(currentPlayer+1)%playerNames.length;
  renderPlayersBar();
  renderHand();
  updateControls();
}

function everyonePassed(){
  for(let i=0;i<playerNames.length;i++){
    if(!passes[i]) return false;
  }
  return true;
}

function endByWinner(i){
  document.getElementById('winnerName').textContent = playerNames[i];
  document.getElementById('finalOverlay').style.display = 'flex';
  startFireworks(); // üéÜ –∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –∑–≤—É–∫–∞
}

function endByPoints(){
  let best=Infinity, wi=0;
  for(let i=0;i<playerNames.length;i++){
    const s=(hands[i]||[]).length;
    if(s<best){ best=s; wi=i; }
  }
  endByWinner(wi);
}
  /* ===========================================================================================
   Fireworks + Sound
=========================================================================================== */
const fwCanvas = document.getElementById('fireworksCanvas');
const fwCtx = fwCanvas.getContext('2d');
const winSound = document.getElementById('winSound');
let fwParticles = [];
let fwRunning = false;

function resizeFW(){
  fwCanvas.width = window.innerWidth;
  fwCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeFW);
resizeFW();

function launchFirework(){
  const colors = ["#ff4d6d","#ffd93d","#00f5d4","#9d4edd","#f72585","#4cc9f0"];
  const x = Math.random() * fwCanvas.width;
  const y = Math.random() * fwCanvas.height/2;
  for(let i=0;i<100;i++){
    fwParticles.push({
      x, y,
      angle: Math.random()*2*Math.PI,
      speed: Math.random()*5+2,
      life: 100,
      color: colors[Math.floor(Math.random()*colors.length)]
    });
  }
}

function updateFW(){
  fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height);
  fwParticles.forEach((p,i)=>{
    p.x += Math.cos(p.angle)*p.speed;
    p.y += Math.sin(p.angle)*p.speed;
    p.life -= 2;
    fwCtx.fillStyle = p.color;
    fwCtx.globalAlpha = Math.max(p.life/100,0);
    fwCtx.beginPath();
    fwCtx.arc(p.x,p.y,2,0,Math.PI*2);
    fwCtx.fill();
  });
  fwParticles = fwParticles.filter(p=>p.life>0);
  if(fwRunning) requestAnimationFrame(updateFW);
}

function startFireworks(){
  fwCanvas.style.display="block";
  fwRunning=true;

  // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ
  if (winSound) {
    winSound.currentTime = 0;
    winSound.play().catch(err => {
      console.warn("–ê–≤—Ç–æ–ø–ª–µ–π –∑–≤—É–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:", err);
    });
  }

  setInterval(launchFirework,600);
  updateFW();
}



/* ===========================================================================================
   Deck (from data) + default
=========================================================================================== */
function buildDeckFromData(d){
  const out=[];
  const A = (d && Array.isArray(d.listA)) ? d.listA : [];
  if(A.length){
    for(let i=0;i<A.length;i++){
      for(let j=i;j<A.length;j++){
        out.push({ a:A[i], b:A[j], uid:uid() });
      }
    }
  }
  return out;
}
function makeDefaultDeck(){
  const F=["–∫–æ—Ç","–ø—ë—Å","–ª—É–Ω–∞","—Å–æ–ª–Ω—Ü–µ","–∑–≤–µ–∑–¥–∞","–º–æ—Å—Ç","—Ä–µ–∫–∞","–¥–æ–º","–ª–µ—Å","–º–æ—Ä–µ","—Å–∞–º–æ–ª—ë—Ç"];
  const out=[];
  for(let i=0;i<F.length;i++){
    for(let j=i;j<F.length;j++){
      out.push({ a:F[i], b:F[j], uid:uid() });
    }
  }
  return out;
}

/* –æ—Ü–µ–Ω–∫–∞ –µ–¥–∏–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ */
function computeUniformSize(allWords){
  const meas=document.createElement('div');
  meas.style.cssText=`position:fixed;left:-9999px;top:-9999px;width:${TILE_W/2-24}px;white-space:nowrap;font-weight:900;font-family:Inter,system-ui,sans-serif;`;
  document.body.appendChild(meas);
  let min=30;
  for(const w of allWords){
    let s=30; meas.style.fontSize=s+'px'; meas.textContent=w;
    while(s>10 && meas.scrollWidth>meas.clientWidth){
      s--; meas.style.fontSize=s+'px';
    }
    min=Math.min(min,s);
  }
  document.body.removeChild(meas);
  uniformTileFontSize=min;
}

/* ===========================================================================================
   Start game
=========================================================================================== */
function startGame(){
  const n=Math.max(2,Math.min(4,parseInt(playerCountEl.value)||2));

  // names
  playerNames=[];
  for(let i=0;i<n;i++){
    playerNames.push((document.getElementById('pname'+i)?.value||'').trim()||('–ò–≥—Ä–æ–∫ '+(i+1)));
  }

  // deck ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∏–∑ ?data=listA, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç
  const data = getQueryData() || {};
  deck = buildDeckFromData(data);
  if(!deck.length){ deck = makeDefaultDeck(); }
  shuffle(deck);

  // —à—Ä–∏—Ñ—Ç: –µ–¥–∏–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ–¥ –≤—Å–µ —Å–ª–æ–≤–∞ –∫–æ–ª–æ–¥—ã
  computeUniformSize([...new Set(deck.flatMap(t=>[t.a,t.b]))]);

  // reset hands/pass
  hands={}; passes={}; currentPlayer=0;
  for(let i=0;i<n;i++){ hands[i]=[]; passes[i]=0; }

  // —Ä–∞–∑–¥–∞—á–∞ 7 –∫–æ—Å—Ç—è—à–µ–∫
  for(let r=0;r<7;r++){
    for(let i=0;i<n;i++){
      if(!deck.length) break;
      hands[i].push(deck.shift());
    }
  }

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –Ω–∞ –ø–æ–ª–µ
  chainZoom.innerHTML='';
  const sx=Math.floor((br().w-TILE_W)/2);
  const sy=Math.floor((br().h-TILE_H)/2);
  const start=deck.shift() || {a:'–°—Ç–∞—Ä—Ç', b:'–°—Ç–∞—Ä—Ç'};
  const startTile = createTileEl(start.a,start.b,{ left:sx, top:sy, orient:'h' });
  chainZoom.appendChild(startTile);

  openLeft = start.a;
  openRight = start.b;
  endLeft  = { x:sx, y:sy, orient:'h', dir:-1, el:startTile };
  endRight = { x:sx, y:sy, orient:'h', dir: 1, el:startTile };

  renderPlayersBar();
  renderHand();
  updateControls();
  fitChain();

  menuEl.style.display='none';
  document.getElementById('title').textContent='Domino ¬∑ Classic';
}

/* ===========================================================================================
   Buttons & DnD
=========================================================================================== */
drawBtn.addEventListener('click', ()=>{
  const hand=hands[currentPlayer]||[];
  if(hasPlayable(hand)) return;
  if(!deck.length) return;
  hand.push(deck.shift());
  hands[currentPlayer]=hand;
  renderHand();
  updateControls();
});

skipBtn.addEventListener('click', ()=>{
  passes[currentPlayer]=(passes[currentPlayer]||0)+1;
  if(everyonePassed()){ endByPoints(); return; }
  nextPlayer();
});

restartBtn.addEventListener('click', ()=>location.reload());
startBtn.addEventListener('click', startGame);

addEventListener('dragover', e=>{
  if(dragging) e.preventDefault();
});

addEventListener('drop', e=>{
  const t=e.target;
  if(!dragging) return;
  if(t && t.classList && t.classList.contains('dz')){
    e.preventDefault();
    const ok=tryPlace(t,dragging);
    if(ok){
      const arr=hands[dragging.owner]||[];
      hands[dragging.owner]=arr.filter(x=>x.uid!==dragging.uid);
      renderHand();
      if(hands[dragging.owner].length===0){
        endByWinner(dragging.owner);
        dragging=null;
        clearZones();
        return;
      }
      passes[currentPlayer]=0;
      nextPlayer();
    }
    dragging=null;
    clearZones();
  }
});

// –ø–æ–¥—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å DZ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
addEventListener('mousemove', ()=>{
  if(dragging) renderDirectionalZones();
});

/* ===========================================================================================
   Safety init (render inputs immediately)
=========================================================================================== */
(function(){
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ renderNameInputs(); });
  } else {
    renderNameInputs();
  }
})();
</script>
</body>
</html>
